---
apiVersion: batch/v1
kind: Job
metadata:
  name: zitadel-org-bootstrap
spec:
  ttlSecondsAfterFinished: 86400  # Clean up after 24 hours
  backoffLimit: 3
  template:
    metadata:
      labels:
        app: zitadel-org-bootstrap
    spec:
      restartPolicy: OnFailure
      serviceAccountName: default
      containers:
        - name: bootstrap
          image: python:3.12-alpine
          command:
            - /bin/sh
            - -c
            - |
              set -e

              # Install required packages
              pip install --no-cache-dir requests pyjwt cryptography

              echo "Waiting for Zitadel to be ready..."
              python3 -c "
              import time
              import requests

              while True:
                  try:
                      resp = requests.get('http://zitadel:8080/debug/ready', timeout=5)
                      if resp.status_code == 200:
                          print('Zitadel is ready!')
                          break
                  except:
                      pass
                  print('Zitadel not ready, waiting...')
                  time.sleep(5)
              "

              # Run the bootstrap script
              python3 << 'PYTHON_SCRIPT'
              import json
              import time
              import requests
              import jwt
              from datetime import datetime, timedelta

              # Configuration
              ZITADEL_DOMAIN = "zitadel.x3y.space"
              ORG_ID = "360051918820605983"
              ORG_NAME = "home"

              # Load the service account key
              with open('/var/run/secrets/zitadel/iam-admin.json', 'r') as f:
                  sa_key = json.load(f)

              print("Authenticating with Zitadel using service account...")

              # Create JWT assertion
              now = datetime.utcnow()
              claims = {
                  "iss": sa_key["userId"],
                  "sub": sa_key["userId"],
                  "aud": f"https://{ZITADEL_DOMAIN}",
                  "iat": int(now.timestamp()),
                  "exp": int((now + timedelta(hours=1)).timestamp())
              }

              # Sign the JWT with the private key
              assertion = jwt.encode(
                  claims,
                  sa_key["key"],
                  algorithm="RS256",
                  headers={"kid": sa_key["keyId"]}
              )

              # Get access token
              token_data = {
                  "grant_type": "urn:ietf:params:oauth:grant-type:jwt-bearer",
                  "scope": "openid profile email urn:zitadel:iam:org:project:id:zitadel:aud",
                  "assertion": assertion
              }

              token_resp = requests.post(
                  f"https://{ZITADEL_DOMAIN}/oauth/v2/token",
                  data=token_data,
                  headers={"Content-Type": "application/x-www-form-urlencoded"}
              )

              if token_resp.status_code != 200:
                  print(f"Failed to authenticate: {token_resp.status_code}")
                  print(f"Response: {token_resp.text}")
                  exit(1)

              access_token = token_resp.json()["access_token"]
              print("Successfully authenticated!")

              # Check if org exists
              print(f"Checking if org {ORG_ID} exists...")
              headers = {
                  "Authorization": f"Bearer {access_token}",
                  "Accept": "application/json"
              }

              org_check = requests.get(
                  f"https://{ZITADEL_DOMAIN}/management/v1/orgs/{ORG_ID}",
                  headers=headers
              )

              if org_check.status_code == 200:
                  print(f"Organization {ORG_ID} already exists, skipping creation")
                  exit(0)

              # Create org
              print(f"Creating organization {ORG_ID}...")
              create_data = {
                  "name": ORG_NAME,
                  "id": ORG_ID
              }

              create_resp = requests.post(
                  f"https://{ZITADEL_DOMAIN}/management/v1/orgs",
                  headers={**headers, "Content-Type": "application/json"},
                  json=create_data
              )

              if create_resp.status_code in [200, 201]:
                  print(f"Successfully created organization {ORG_ID}")
                  print(f"Response: {create_resp.json()}")
              else:
                  print(f"Failed to create organization: {create_resp.status_code}")
                  print(f"Response: {create_resp.text}")
                  exit(1)
              PYTHON_SCRIPT
          volumeMounts:
            - name: iam-admin
              mountPath: /var/run/secrets/zitadel
              readOnly: true
      volumes:
        - name: iam-admin
          secret:
            secretName: iam-admin

---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: matrix-synapse
spec:
  chart:
    spec:
      chart: matrix-synapse
      version: 3.12.19
      sourceRef:
        kind: HelmRepository
        name: ananace-charts
        namespace: home-system
  interval: 1h
  values:
    serverName: "matrix.${DOMAIN1}"
    publicServerName: "matrix.${DOMAIN1}"

    workers:
      media_repository:
        enabled: false

    ingress:
      enabled: false

    postgresql:
      enabled: false

    externalPostgresql:
      host: pg-default-rw.db.svc.cluster.local
      port: 5432
      username: "${PG_USER}"
      password: "${PG_PASSWORD}"
      database: synapse

    redis:
      enabled: false

    externalRedis:
      host: redis.db.svc.cluster.local
      port: 6379
      password: "${REDIS_PASSWORD}"
      dbid: 1

    persistence:
      enabled: true
      existingClaim: matrix-synapse

    config:
      enableRegistration: true
      # Bridge configuration files - user needs to ensure these exist
      app_service_config_files:
        - /data/whatsapp/registration.yaml
        - /data/telegram/registration.yaml
        - /data/slack/registration.yaml

    synapse:
      extraVolumeMounts:
        - name: wa-vol
          mountPath: /data/whatsapp
        - name: telegram-vol
          mountPath: /data/telegram
        - name: slack-vol
          mountPath: /data/slack
      extraVolumes:
        - name: wa-vol
          secret:
            secretName: mautrix-whatsapp-registration
            optional: true
        - name: telegram-vol
          secret:
            secretName: mautrix-telegram-registration
            optional: true
        - name: slack-vol
          secret:
            secretName: mautrix-slack-registration
            optional: true

    route:
      app:
        annotations:
          gethomepage.dev/enabled: "true"
          gethomepage.dev/name: Matrix
          gethomepage.dev/description: Communications
          gethomepage.dev/group: Social
          gethomepage.dev/icon: matrix.png
        hostnames:
          - "matrix.${DOMAIN1}"
        parentRefs:
          - name: envoy-internal
            namespace: network

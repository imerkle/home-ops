---
# yaml-language-server: $schema=https://kubernetes-schemas.pages.dev/helm.toolkit.fluxcd.io/helmrelease_v2.json
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: stalwart
spec:
  interval: 30m
  chartRef:
    kind: OCIRepository
    name: stalwart
  install:
    remediation:
      retries: 3
  upgrade:
    remediation:
      retries: 3
  values:
    # Chart expects config under `config.*` and env as list entries, not a key/value map.
    # Keep this receive-focused and configure outbound relay in Stalwart admin once deployed.
    backup:
      enabled: false
    config:
      server:
        listener:
          smtp:
            bind: ["[::]:25"]
            protocol: "smtp"
          imap:
            bind: ["[::]:143"]
            protocol: "imap"
          imaptls:
            bind: ["[::]:993"]
            protocol: "imap"
            tls:
              implicit: true
          http:
            protocol: "http"
            bind: ["[::]:80"]
          https:
            protocol: "http"
            bind: ["[::]:443"]
            tls:
              implicit: true
    service:
      type: LoadBalancer
      annotations:
        external-dns.alpha.kubernetes.io/hostname: "mail.${DOMAIN1}"
        external-dns.alpha.kubernetes.io/cloudflare-proxied: "false"
      ports:
        smtp: 25
        imap: 143
        imaptls: 993
        http: 80
        https: 443
    certificate:
      certmanager:
        issuerRef:
          name: letsencrypt-prodxs
        dnsNames:
          - "mail.mail.${DOMAIN1}"